# Receiving the dungeon map data

The dungeon map data contains both the tile information and the monster information. The monster data is covered [here](monsters.qmd).

## Structure of the map data

The tiles data sent is sent with the least amount of repeated information. Below is a dump of the `map` information according to the image. This dump is extremely small, compared to most, because it only contains a very small proportion of the map. This is seed `31` on version `0.30`.

![](images/map/map_tiles_1.JPG)

```python
{"msg":"map","clear":true,"player_on_level":true,"vgrdc":{"x":0,"y":0},"cells":[{"x":-2,"y":-2,"f":7,"mf":2,"g":"#","col":6,"t":{"bg":994}},{"f":7,"mf":2,"g":"#","col":6,"t":{"bg":993}},{"f":7,"mf":2,"g":"#","col":6,"t":{"bg":994}},{"f":7,"mf":2,"g":"#","col":6,"t":{"bg":996}},{"x":-2,"y":-1,"f":7,"mf":2,"g":"#","col":6,"t":{"bg":995}},{"f":33,"mf":1,"g":".","col":7,"t":{"bg":6,"ov":[2317,2319]}},{"f":33,"mf":1,"g":".","col":7,"t":{"bg":6,"ov":[2319,2321]}},{"f":7,"mf":2,"g":"#","col":6,"t":{"bg":993}},{"x":-3,"y":0,"mf":26},{"f":7,"mf":2,"g":"#","col":6,"t":{"bg":994}},{"f":33,"mf":1,"g":".","col":7,"t":{"bg":5,"ov":[2317]}},{"f":60,"mf":12,"g":"@","col":87,"t":{"fg":530691,"bg":2570,"flv":{"f":8,"s":227},"doll":[[6602,32],[6562,32],[6681,32],[6732,32],[7367,32],[6976,32]],"mcache":null,"ov":[2321]}},{"f":7,"mf":2,"g":"#","col":6,"t":{"bg":996}},{"x":-3,"y":1,"mf":26},{"f":1,"mf":5,"g":"+","col":7,"t":{"bg":2386,"flv":{"f":4}}},{"f":33,"mf":1,"g":".","col":7,"t":{"bg":6,"ov":[2317]}},{"f":33,"mf":1,"g":".","col":7,"t":{"bg":5,"ov":[2321]}},{"f":7,"mf":2,"g":"#","col":6,"t":{"bg":996}},{"x":-3,"y":2,"mf":26},{"f":7,"mf":2,"g":"#","col":6,"t":{"bg":995}},{"f":7,"mf":2,"g":"#","col":6,"t":{"bg":994}},{"f":7,"mf":2,"g":"#","col":6,"t":{"bg":996}},{"f":7,"mf":2,"g":"#","col":6,"t":{"bg":998}}]}
```

The following is an exploration of the data contained in the `cells` key seen above.

### `mf` information

Each cell will provide an 'mf' number. Here is the concordance list. The missing keys are likely no longer used (related mostly to monster and player info).

```
1: "floor",
2: "wall",
3: "magic mapping floor",
4: "magic mapping wall",
5: "door",
6: "item",
11: "plant",
12: "up stairs"
13: "down stairs"
14: "branch stairs (e.g. temple)"
15: "feature (e.g. altar)"
16: "shallow water"
17: "lava"
18: "trap"
22: "deep water"
23: "portal (e.g. sewer entrance)"
24: "portal (up or down)"
25: "portal (up or down)"
26: "unexplored"
```

### Data structure with `x` and `y`

The `cells` item value is a list of tiles. Only the first tile in a row, or the first tile after a series of "empty cells" in a row (cells not sent), will contain the `x` and `y` value. For example, the first cell in the list contains `'x': -2` and `'y': -8`. On the image, assuming the character is at `'x': 0` and `'y': 0` and that x negative is left and x positive is right, and that y negative is up and y positive is down, this cell is out of bound (labelled '1' in the image). This cell contains `'mf': 26"` as it is unexplored (`{"x": -2, "y": -8, "mf": 26}`). This data is followed by 3 cells without the `x` and `y` value (labelled '2', '3' and '4' in the image), also all unexplored (`{"mf": 26}, {"mf": 26}, {"mf": 26}`). All known tiles will always be bordered by either unexplored tiles or a wall, this is the reason why no data is provided for the "tile" labelled '5', since there is no way of reaching this tile from the known tiles. Once a row is complete, the next item in the list will contain the `x` and `y` value for the next row (`{"x": -2, "y": -7, "mf": 26}`).

### Glyph

Looking at the `g` data (glyph) in the known tiles will provide the `console` character for each tile. For example, a "floor" will have `.` and a "wall" will have `#`. The character will be labled as `@` and the invisible monsters will leave a disturbance labled as `{`.

## Updating the map data

During the processing of the game, the map data gets updated very frequently, but only near tiles (or tiles that update) get re-sent to the client. Below is an example of the updated data sent if the character moves down and to the left (`x: -1` and `y: 1`).

![](images/map/map_tiles_2.JPG)

```json
{'msg': 'map', 'vgrdc': {'x': -1, 'y': 1}, 'cells': [{'x': -2, 'y': -8, 'mf': 26}, {'mf': 26}, {'mf': 26}, {'mf': 26}, {'x': -2, 'y': -7, 'mf': 26}, {'col': 8, 't': {'bg': 262150}}, {'col': 8, 't': {'bg': 262146}}, {'col': 8, 't': {'bg': 263132}}, {'mf': 26}, {'x': -4, 'y': -6, 'col': 8, 't': {'bg': 263126}}, {'x': -1, 'y': -6, 'col': 8, 't': {'bg': 262147}}, {'x': 2, 'y': -6, 'mf': 26}, {'x': -4, 'y': -5, 'mf': 26}, {'x': -1, 'y': -5, 'col': 8, 't': {'bg': 262147}}, {'x': 2, 'y': -5, 'mf': 26}, {'x': -4, 'y': -4, 'mf': 26}, {'x': 2, 'y': -4, 'mf': 26}, {'x': 0, 'y': 0, 'g': '<', 'col': 2, 't': {'fg': 0, 'doll': None, 'mcache': None}}, {'x': -1, 'y': 1, 'g': '@', 'col': 87, 't': {'fg': 530466, 'doll': [[6369, 32], [6327, 32], [6446, 32], [6497, 32], [7098, 32], [6734, 32]], 'mcache': None}}]}
```

The data shows that the character (`'g': '@'`) is now located at `'x': -1` and `'y': 1` and where the character used to be (`'x': 0` and `'y': 0`) a up-stairs (`'g': '<'`) is now present.